"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};THREE.DRACOLoader=function(e){THREE.Loader.call(this,e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}},THREE.DRACOLoader.prototype=Object.assign(Object.create(THREE.Loader.prototype),{constructor:THREE.DRACOLoader,setDecoderPath:function(e){return this.decoderPath=e,this},setDecoderConfig:function(e){return this.decoderConfig=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},setVerbosity:function(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")},setDrawMode:function(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")},setSkipDequantization:function(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")},load:function(e,r,t,o){var n=this,a=new THREE.FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(e){var t={attributeIDs:n.defaultAttributeIDs,attributeTypes:n.defaultAttributeTypes,useUniqueIDs:!1};n.decodeGeometry(e,t).then(r).catch(o)},t,o)},decodeDracoFile:function(e,t,r,o){r={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:o||this.defaultAttributeTypes,useUniqueIDs:!!r};this.decodeGeometry(e,r).then(t)},decodeGeometry:function(r,o){var e,t=this;for(e in o.attributeTypes){var n=o.attributeTypes[e];void 0!==n.BYTES_PER_ELEMENT&&(o.attributeTypes[e]=n.name)}var a,s=JSON.stringify(o);if(THREE.DRACOLoader.taskCache.has(r)){var i=THREE.DRACOLoader.taskCache.get(r);if(i.key===s)return i.promise;if(0===r.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var d=this.workerNextTaskID++,i=r.byteLength,i=this._getWorker(d,i).then(function(e){return a=e,new Promise(function(e,t){a._callbacks[d]={resolve:e,reject:t},a.postMessage({type:"decode",id:d,taskConfig:o,buffer:r},[r])})}).then(function(e){return t._createGeometry(e.geometry)});return i.catch(function(){return!0}).then(function(){a&&d&&t._releaseTask(a,d)}),THREE.DRACOLoader.taskCache.set(r,{key:s,promise:i}),i},_createGeometry:function(e){var t=new THREE.BufferGeometry;e.index&&t.setIndex(new THREE.BufferAttribute(e.index.array,1));for(var r=0;r<e.attributes.length;r++){var o=e.attributes[r],n=o.name,a=o.array,o=o.itemSize;t.setAttribute(n,new THREE.BufferAttribute(a,o))}return t},_loadLibrary:function(r,e){var o=new THREE.FileLoader(this.manager);return o.setPath(this.decoderPath),o.setResponseType(e),o.setWithCredentials(this.withCredentials),new Promise(function(e,t){o.load(r,e,void 0,t)})},preload:function(){return this._initDecoder(),this},_initDecoder:function(){var r=this;if(this.decoderPending)return this.decoderPending;var o="object"!==("undefined"==typeof WebAssembly?"undefined":_typeof(WebAssembly))||"js"===this.decoderConfig.type,e=[];return o?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then(function(e){var t=e[0];o||(r.decoderConfig.wasmBinary=e[1]);e=THREE.DRACOLoader.DRACOWorker.toString(),e=["/* draco decoder */",t,"","/* worker */",e.substring(e.indexOf("{")+1,e.lastIndexOf("}"))].join("\n");r.workerSourceURL=URL.createObjectURL(new Blob([e]))}),this.decoderPending},_getWorker:function(e,t){var o=this;return this._initDecoder().then(function(){var r;return o.workerPool.length<o.workerLimit?((r=new Worker(o.workerSourceURL))._callbacks={},r._taskCosts={},r._taskLoad=0,r.postMessage({type:"init",decoderConfig:o.decoderConfig}),r.onmessage=function(e){var t=e.data;switch(t.type){case"decode":r._callbacks[t.id].resolve(t);break;case"error":r._callbacks[t.id].reject(t);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+t.type+'"')}},o.workerPool.push(r)):o.workerPool.sort(function(e,t){return e._taskLoad>t._taskLoad?-1:1}),(r=o.workerPool[o.workerPool.length-1])._taskCosts[e]=t,r._taskLoad+=t,r})},_releaseTask:function(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]},debug:function(){console.log("Task load: ",this.workerPool.map(function(e){return e._taskLoad}))},dispose:function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),THREE.DRACOLoader.DRACOWorker=function(){var r,t;onmessage=function(e){var a=e.data;switch(a.type){case"init":r=a.decoderConfig,t=new Promise(function(t){r.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(r)});break;case"decode":var s=a.buffer,i=a.taskConfig;t.then(function(e){var t=e.draco,r=new t.Decoder,e=new t.DecoderBuffer;e.Init(new Int8Array(s),s.byteLength);try{var o=function(e,t,r,o){var n,a,s=o.attributeIDs,i=o.attributeTypes,d=t.GetEncodedGeometryType(r);if(d===e.TRIANGULAR_MESH)n=new e.Mesh,a=t.DecodeBufferToMesh(r,n);else{if(d!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");n=new e.PointCloud,a=t.DecodeBufferToPointCloud(r,n)}if(!a.ok()||0===n.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+a.error_msg());var c,u,f,h={index:null,attributes:[]};for(c in s){var l=self[i[c]];if(o.useUniqueIDs)f=s[c],u=t.GetAttributeByUniqueId(n,f);else{if(-1===(f=t.GetAttributeId(n,e[s[c]])))continue;u=t.GetAttribute(n,f)}h.attributes.push(function(e,t,r,o,n,a){var s=a.num_components(),i=r.num_points()*s,d=i*n.BYTES_PER_ELEMENT,c=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,n),u=e._malloc(d);t.GetAttributeDataArrayForAllPoints(r,a,c,d,u);i=new n(e.HEAPF32.buffer,u,i).slice();return e._free(u),{name:o,array:i,itemSize:s}}(e,t,n,c,l,u))}d===e.TRIANGULAR_MESH&&(h.index=function(e,t,r){var o=3*r.num_faces(),n=4*o,a=e._malloc(n);t.GetTrianglesUInt32Array(r,n,a);o=new Uint32Array(e.HEAPF32.buffer,a,o).slice();return e._free(a),{array:o,itemSize:1}}(e,t,n));return e.destroy(n),h}(t,r,e,i),n=o.attributes.map(function(e){return e.array.buffer});o.index&&n.push(o.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:o},n)}catch(e){console.error(e),self.postMessage({type:"error",id:a.id,error:e.message})}finally{t.destroy(e),t.destroy(r)}})}}},THREE.DRACOLoader.taskCache=new WeakMap,THREE.DRACOLoader.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},THREE.DRACOLoader.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},THREE.DRACOLoader.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},THREE.DRACOLoader.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")};